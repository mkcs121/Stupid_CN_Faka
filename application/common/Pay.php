<?php
/* QQ：2337350403 - 官网：www.mfxw.cc */
 namespace app\common; use app\common\util\notify\Sell; use think\Db; use think\Exception; class Pay { protected $error = ''; public function getError() { return $this->error; } public static $instance = []; public static function load($channel, $account = []) { $code = $channel->code; if (isset($account["\x70\x61\x72\x61\x6d\163"]->refer)) { goto ftxdv; } $account["\160\141\x72\141\x6d\163"]->refer = ''; ftxdv: $class = "\x5c\x61\x70\160\x5c\143\157\x6d\155\x6f\156\134\160\x61\171\x5c" . $code; if (isset(SELF::$instance[$code])) { goto SXsnn; } SELF::$instance[$code] = new $class(); SELF::$instance[$code]->channel = $channel; SELF::$instance[$code]->account = $account; SXsnn: return SELF::$instance[$code]; } public function completeOrderBySelf(&$order) { Db::startTrans(); try { goto YDRWu; YDRWu: $time = time(); $res = Db::table("\157\162\x64\145\162")->where(["\151\x64" => $order->id, "\x73\x74\x61\164\165\x73" => 0])->update(["\x73\x74\x61\x74\x75\163" => 1, "\x73\165\x63\143\145\x73\x73\137\x61\x74" => $time]); if ($res) { goto xSxTQ; } Db::rollback(); exit; xSxTQ: $user = Db::table("\165\163\x65\x72")->lock(true)->where("\x69\144", $order->user_id)->find(); $order_total = $order->total_product_price; if (!$user) { goto JAQpN; } $poundage = $user["\160\157\165\156\x64\x61\x67\145"]; goto R7F9F; EZw4X: d7uQe: if ($order->fee_payer == 1) { goto MCknD; } $freezeMoney = round($order_total - $smsPrice, 3); goto vU_fA; MCknD: $freezeMoney = round($order_total - $order->fee - $smsPrice, 3); vU_fA: $order->finally_money = $freezeMoney; $order->save(); if (!($freezeMoney >= 0)) { goto CeFGT; } goto HoxlH; R7F9F: if (!(($order->fee_payer == 1 || $order->fee_payer == 2) && $order->fee > 0)) { goto tOSsV; } Db::table("\x75\x73\x65\162")->where("\x69\x64", $order->user_id)->update(["\x70\x6f\x75\156\144\x61\147\x65" => ["\x65\170\x70", "\160\x6f\x75\x6e\x64\141\147\x65\55" . $order->fee]]); $balance = round($poundage - $order->fee, 3); if (!($balance < 0)) { goto jtYwi; } throw new Exception("\xe5\225\206\xe5\xae\266\346\211\x8b\347\xbb\255\350\264\xb9\xe4\270\215\350\266\xb3\xe4\xbb\xa5\xe6\211\243\351\x99\xa4\xe6\211\213\xe7\xbb\255\350\264\xb9"); jtYwi: record_user_money_log("\147\x6f\x6f\144\x73\137\x73\157\154\x64", $user["\x69\x64"], -$order->fee, $user["\155\157\156\x65\171"], "\346\x88\x90\345\212\x9f\xe5\224\256\xe5\207\272\xe5\225\206\xe5\x93\x81{$order->goods_name}\357\xbc\x88{$order->quantity}\345\274\xa0\357\274\211\xe6\x89\243\xe9\231\xa4\xe4\272\xa4\xe6\230\223\346\211\213\xe7\xbb\xad\xe8\264\271\xef\274\214\350\xae\xa2\xe5\215\x95\xef\274\x9a{$order->trade_no}"); tOSsV: $smsPrice = 0; if (!($order->sms_payer == 1)) { goto d7uQe; } goto dq82z; HoxlH: $unfreezeTime = strtotime(date("\x59\55\x6d\x2d\x64", $time)) + 86400; record_user_money_log("\146\x72\x65\145\x7a\145", $user["\x69\x64"], 0, $user["\155\x6f\156\145\171"], "\345\206\273\xe7\273\x93\350\xae\xa2\xe5\215\x95\357\xbc\x9a{$order->trade_no}\xef\xbc\x8c\345\x86\273\xe7\273\x93\351\x87\x91\xe9\xa2\235\xef\xbc\232\x30\345\x85\203\x28\x54\x30\40\350\256\xa1\347\256\227\x29"); Db::table("\141\x75\x74\x6f\137\x75\x6e\x66\x72\x65\145\x7a\x65")->insert(["\x74\x72\141\x64\x65\x5f\x6e\157" => $order->trade_no, "\x75\x73\x65\x72\x5f\x69\144" => $user["\x69\x64"], "\x6d\157\156\145\171" => 0, "\165\156\x66\x72\145\x65\172\145\137\x74\151\x6d\x65" => $unfreezeTime, "\143\x72\145\x61\164\x65\144\x5f\141\x74" => $time]); CeFGT: JAQpN: Db::commit(); $notify = new Sell(); $notify->notify($order, $freezeMoney); goto wPnvI; dq82z: if (!($order->sms_notify == 1)) { goto nTSr6; } $smsPrice = get_sms_cost(); Db::table("\165\x73\x65\162")->where("\151\144", $order->user_id)->update(["\x70\157\165\x6e\x64\x61\x67\145" => ["\145\170\x70", "\160\x6f\x75\156\x64\141\x67\145\x2d" . $smsPrice]]); $poundage = round($poundage - $smsPrice, 3); if (!($poundage < 0)) { goto VM1wf; } throw new Exception("\345\225\206\xe5\xae\xb6\346\211\213\xe7\273\255\350\264\271\xe4\xb8\x8d\xe8\xb6\xb3\xe4\273\xa5\346\211\xa3\xe9\x99\xa4\347\x9f\255\xe4\277\xa1\xe8\xb4\271"); VM1wf: record_user_money_log("\147\x6f\157\144\x73\x5f\163\x6f\154\144", $user["\151\144"], -$smsPrice, $user["\155\x6f\x6e\x65\x79"], "\xe6\211\243\351\x99\244\xe7\x9f\xad\xe4\xbf\xa1\350\264\xb9\xef\274\214\xe8\xae\xa2\xe5\x8d\225\357\xbc\232{$order->trade_no}"); Db::table("\157\x72\144\145\x72")->where("\151\x64", $order->id)->update(["\x73\155\163\137\160\x72\151\x63\x65" => $smsPrice]); nTSr6: goto EZw4X; wPnvI: } catch (\Exception $e) { Db::rollback(); record_file_log("\143\157\x6d\160\154\145\x74\145\137\145\x72\162\x6f\x72", $order->trade_no . $e->getMessage()); record_file_log("\x63\x6f\155\160\x6c\x65\x74\x65\137\145\x72\162\x6f\162", $e->getTraceAsString()); die("\x65\162\x72\157\x72"); } return true; } public function completeOrder(&$order) { Db::startTrans(); try { goto Vftq_; TqOqB: t2M3W: ZHqeY: if ($order->fee_payer == 1) { goto JVEhH; } $freezeMoney = round($money - $smsPrice, 3); goto ehUk7; JVEhH: $freezeMoney = round($money - $order->fee - $smsPrice, 3); ehUk7: $order->finally_money = $freezeMoney; $order->save(); goto W7zz2; ZrIqx: goto N0ZlB; ZPB_Y: $proxyGoods = Db::table("\147\x6f\x6f\144\163")->where("\151\144", $order->proxy_id)->find(); if ($proxyGoods) { goto EFo98; } throw new Exception("\xe5\x8e\x9f\345\x95\x86\345\x93\x81\344\xb8\215\xe5\255\230\xe5\x9c\250"); EFo98: $unfreezeTime = strtotime(date("\x59\x2d\155\x2d\144", $time)) + 86400; $proxy_user = Db::table("\165\163\x65\x72")->where("\x69\144", $proxyGoods["\x75\163\x65\162\x5f\x69\x64"])->update(["\x66\x72\x65\145\172\145\137\155\x6f\x6e\145\171" => ["\145\170\x70", "\146\162\x65\145\x7a\x65\x5f\155\x6f\x6e\x65\171\53" . round($order->goods_cost_price * $order->quantity, 3)]]); Db::table("\141\x75\x74\157\137\x75\156\146\x72\145\145\172\145")->insert(["\x74\x72\x61\144\145\137\156\157" => $order->trade_no, "\165\163\145\162\x5f\151\x64" => $proxyGoods["\165\x73\x65\x72\x5f\x69\x64"], "\x6d\x6f\156\145\x79" => round($order->goods_cost_price * $order->quantity, 3), "\x75\x6e\x66\162\145\x65\x7a\145\x5f\164\151\155\145" => $unfreezeTime, "\x63\x72\145\x61\x74\x65\144\x5f\x61\164" => $time]); record_user_money_log("\147\x6f\x6f\144\x73\x5f\x73\x6f\x6c\144", $proxyGoods["\165\x73\145\x72\x5f\x69\144"], round($order->goods_cost_price * $order->quantity, 3), round($proxy_user["\x6d\157\156\x65\x79"] + round($order->goods_cost_price * $order->quantity, 3), 3), "\xe6\210\220\345\212\x9f\xe5\x94\xae\xe5\207\xba\350\242\xab\344\273\xa3\347\220\x86\345\x95\x86\xe5\x93\201{$order->goods_name}\xef\274\x88{$order->quantity}\345\274\240\357\274\x89"); goto C_8pJ; C_8pJ: $money = $order->total_product_price - round($order->goods_cost_price * $order->quantity, 3); N0ZlB: if (sysconf("\155\137\160\x6f\x75\x6e\x64\141\147\145\x5f\x6d\x63\150\151\144") . "\345\205\x85\345\x80\xbc" == $order->goods_name && $order->category == 1) { goto k5ozu; } Db::table("\165\x73\x65\162")->where("\x69\144", $order->user_id)->update(["\155\157\156\x65\171" => ["\x65\x78\160", "\155\157\x6e\145\171\x2b" . $money]]); $balance = round($user["\x6d\157\156\x65\171"] + $money, 3); record_user_money_log("\x67\x6f\157\144\163\x5f\163\x6f\x6c\144", $user["\x69\x64"], $money, $balance, "\xe6\x88\x90\345\212\x9f\xe5\224\256\345\x87\272\xe5\x95\206\345\x93\x81{$order->goods_name}\357\274\210{$order->quantity}\345\274\240\xef\xbc\211"); goto fWn1S; k5ozu: Db::table("\165\x73\145\162")->where("\151\x64", $order->user_id)->update(["\160\x6f\165\x6e\144\x61\x67\x65" => ["\145\170\x70", "\160\x6f\x75\x6e\144\x61\147\x65\x2b" . $money]]); $balance = round($user["\155\x6f\156\145\x79"], 3); goto fNfda; W7zz2: if (!($freezeMoney >= 0)) { goto PcfdQ; } $unfreezeTime = strtotime(date("\131\55\x6d\55\144", $time)) + 86400; if (1 == $order->settlement_type) { goto Sp1ez; } if (0 == $order->settlement_type) { goto qFtps; } goto IPGtT; Sp1ez: Db::table("\165\x73\145\x72")->where("\151\144", $user["\151\x64"])->update(["\x6d\x6f\x6e\145\171" => ["\145\x78\160", "\155\x6f\x6e\x65\x79\x2d" . $freezeMoney], "\x66\162\145\145\x7a\145\137\x6d\x6f\156\x65\x79" => ["\x65\x78\x70", "\x66\x72\x65\x65\x7a\145\x5f\155\x6f\x6e\145\171\x2b" . $freezeMoney]]); $balance = round($balance - $freezeMoney, 3); record_user_money_log("\x66\162\145\x65\x7a\145", $user["\x69\x64"], -$freezeMoney, $balance, "\xe5\x86\xbb\347\273\x93\350\256\242\345\215\225\xef\274\232{$order->trade_no}\xef\xbc\x8c\345\206\xbb\347\xbb\x93\xe9\207\x91\351\xa2\x9d\357\274\232{$freezeMoney}\345\x85\x83"); Db::table("\141\165\x74\x6f\x5f\x75\156\146\x72\x65\145\172\x65")->insert(["\164\x72\x61\144\145\x5f\156\157" => $order->trade_no, "\165\x73\145\x72\x5f\x69\x64" => $user["\151\x64"], "\155\x6f\x6e\145\x79" => $freezeMoney, "\165\156\146\162\145\145\172\145\x5f\x74\x69\155\x65" => $unfreezeTime, "\x63\x72\145\141\x74\145\144\137\141\164" => $time]); goto bsuxP; TBWjo: if (!($order->sms_payer == 1)) { goto ZHqeY; } if (!($order->sms_notify == 1)) { goto t2M3W; } $smsPrice = get_sms_cost(); Db::table("\x75\x73\x65\x72")->where("\151\144", $order->user_id)->update(["\155\x6f\156\145\171" => ["\145\x78\x70", "\x6d\157\156\145\171\55" . $smsPrice]]); $balance = round($balance - $smsPrice, 3); if (!($balance < 0)) { goto XBNzW; } throw new Exception("\345\x95\206\xe5\xae\xb6\xe4\xbd\x99\xe9\242\235\344\270\x8d\350\266\xb3\xe4\xbb\xa5\xe6\x89\243\351\x99\xa4\347\237\255\344\xbf\241\350\264\271"); XBNzW: record_user_money_log("\x67\x6f\x6f\x64\163\x5f\163\x6f\154\144", $user["\x69\144"], -$smsPrice, $balance, "\346\211\243\xe9\x99\xa4\xe7\x9f\255\xe4\277\xa1\350\xb4\271\357\274\214\350\256\xa2\345\215\225\xef\xbc\232{$order->trade_no}"); Db::table("\157\x72\x64\x65\162")->where("\151\144", $order->id)->update(["\x73\x6d\163\x5f\x70\162\x69\x63\x65" => $smsPrice]); goto TqOqB; bsuxP: goto IPGtT; qFtps: record_user_money_log("\x66\162\145\145\172\x65", $user["\x69\144"], 0, $balance, "\xe5\x86\xbb\xe7\xbb\223\350\xae\xa2\xe5\x8d\x95\xef\274\232{$order->trade_no}\357\274\214\xe5\206\273\347\273\223\351\x87\221\351\xa2\235\xef\xbc\x9a\60\345\205\203\50\x54\x30\x20\xe8\xae\xa1\347\xae\227\51"); Db::table("\x61\165\164\157\x5f\165\156\146\162\x65\145\172\x65")->insert(["\x74\x72\141\x64\145\x5f\156\x6f" => $order->trade_no, "\x75\163\x65\x72\137\x69\144" => $user["\x69\144"], "\x6d\x6f\156\x65\171" => 0, "\165\156\x66\x72\x65\x65\x7a\145\137\x74\151\x6d\145" => $unfreezeTime, "\143\162\x65\141\x74\x65\144\137\141\x74" => $time]); IPGtT: PcfdQ: IVxEL: Db::commit(); $notify = new Sell(); $notify->notify($order, $freezeMoney); goto OVMti; vlsEm: if (!($user["\160\x61\162\145\156\164\137\x69\144"] > 0)) { goto CZ5Xf; } $parent = Db::table("\165\163\145\x72")->lock(true)->where("\x69\144", $user["\x70\x61\162\x65\156\164\137\x69\x64"])->find(); $spreadRebateRate = get_spread_rebate_rate(); $rebate = round($order->fee * $spreadRebateRate, 3); if (!($parent && $rebate > 0)) { goto HLgPt; } Db::table("\165\163\145\x72")->where("\151\x64", $parent["\x69\144"])->update(["\155\x6f\x6e\145\171" => ["\145\170\x70", "\155\x6f\156\145\171\53" . $rebate], "\x72\x65\x62\x61\164\x65" => ["\145\170\160", "\162\x65\142\x61\x74\x65\x2b" . $rebate]]); record_user_money_log("\x73\x75\142\x5f\163\x6f\x6c\x64\x5f\x72\145\142\141\164\x65", $parent["\151\144"], $rebate, round($parent["\x6d\x6f\x6e\145\x79"] + $rebate, 3), "\344\270\x8b\347\xba\247\x5b{$user["\165\163\x65\162\x6e\141\155\145"]}\x5d\xe5\224\256\345\207\xba\345\x95\206\xe5\223\201\xef\xbc\x8c\350\xbf\x94\xe4\xbd\243{$rebate}\345\x85\x83"); HLgPt: CZ5Xf: $smsPrice = 0; goto TBWjo; Vftq_: $time = time(); $res = Db::table("\x6f\162\x64\145\162")->where(["\x69\x64" => $order->id, "\x73\x74\x61\164\165\x73" => 0])->update(["\163\164\x61\x74\165\x73" => 1, "\x73\165\143\x63\x65\163\163\137\141\164" => $time]); if ($res) { goto GrLqR; } Db::rollback(); exit; GrLqR: $user = Db::table("\x75\x73\x65\x72")->lock(true)->where("\x69\x64", $order->user_id)->find(); if (!$user) { goto IVxEL; } if ($order->is_proxy == 1) { goto ZPB_Y; } $money = $order->total_product_price; goto ZrIqx; fNfda: record_user_money_log("\147\x6f\x6f\x64\163\137\163\x6f\154\144", $user["\151\144"], $money, $balance, "\346\x88\x90\345\x8a\x9f\xe5\224\xae\xe5\x87\272\345\x95\x86\345\x93\201{$order->goods_name}\xef\274\210{$order->quantity}\xe5\274\xa0\357\xbc\x89"); fWn1S: if (!($order->fee_payer == 1 && $order->fee > 0)) { goto ZbqUj; } Db::table("\165\163\145\x72")->where("\151\144", $order->user_id)->update(["\x6d\157\156\x65\171" => ["\145\x78\160", "\155\157\156\145\x79\55" . $order->fee]]); $balance = round($balance - $order->fee, 3); if (!($balance < 0)) { goto HMDvo; } throw new Exception("\345\x95\206\xe5\256\xb6\xe4\275\231\xe9\242\235\344\xb8\x8d\350\266\263\xe4\273\xa5\xe6\211\xa3\xe9\x99\244\xe6\x89\213\347\273\255\xe8\xb4\xb9"); HMDvo: record_user_money_log("\x67\157\x6f\144\163\137\x73\157\x6c\144", $user["\x69\x64"], -$order->fee, $balance, "\346\211\xa3\xe9\x99\xa4\344\xba\244\346\230\223\346\x89\x8b\347\273\255\xe8\xb4\271\xef\274\214\xe8\256\242\xe5\x8d\225\357\xbc\232{$order->trade_no}"); ZbqUj: goto vlsEm; OVMti: } catch (\Exception $e) { Db::rollback(); record_file_log("\143\x6f\155\160\x6c\x65\x74\x65\x5f\x65\x72\x72\x6f\162", $order->trade_no . $e->getMessage()); record_file_log("\x63\x6f\155\160\x6c\x65\x74\x65\x5f\x65\162\x72\157\162", $e->getTraceAsString()); die("\145\x72\162\157\x72"); } return true; } }