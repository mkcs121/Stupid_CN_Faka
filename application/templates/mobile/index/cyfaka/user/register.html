
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=yes">
    <title>注册_{:sysconf('site_subtitle')}_{:sysconf('site_name')}</title>
    <meta name="keywords" content="{:sysconf('site_keywords')}" />
    <meta name="description" content="{:sysconf('site_desc')}" />
    <link rel="shortcut icon" href="{:sysconf('browser_icon')}" />
    <link rel="stylesheet" href="/static/app/cyfaka/css/qietu.css">
    <link rel="stylesheet" href="/static/app/cyfaka/font/iconfont.css">
    <link rel="stylesheet" href="/static/app/cyfaka/css/header.css">
    <link rel="stylesheet" href="/static/app/cyfaka/css/style.css">
    <link rel="stylesheet" href="/static/app/cyfaka/css/responsive.css">
    <script src="__RES__/app/js/jquery-2.2.1.min.js"></script>
    <script src="__RES__/app/js/formvalidator_min.js"></script>
    <script src="__RES__/app/js/formvalidatorregex.js"></script>
    <script src="__RES__/app/js/layer.js"></script>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>

      <style>
        input, button, select, textarea{
        line-height: normal;
    }
    @media only screen and (min-width: 768px) {
        .layui-layer-iframe{min-height: 400px;}

    }
    @media only screen and (max-width: 768px) {
        .layui-layer-iframe{width: 80%!important;}

    }
</style>
</head>

<body>
<div class="loginpage loginpage-bg">
    <!-- <div class="logo"> -->
        <!-- <a href="/"><img src="https://www.510ka.com/static/upload/073c69667925a221/b2e4ecb35f552080.png"/></a> -->
    <!-- </div> -->
    <div class="reg-wrap" style="height:auto">
        <form action="/register/regsave" id="reg" name="reg" autocomplete="off">
            <input type="hidden" name="spread_userid" value="">
            <div class="head">
                <h2><img src="{:sysconf('site_logo')}"/></h2>
                <h3>用户注册</h3>
                <p>买家无需注册账号</p>
            </div>
            <div class="body">
                <ul>
                    <li>
                        <i class="iconfont icon-yonghu"></i>
                        <input class="res-user" type="text" id="newusername" name="reginfo[username]" value="" placeholder="注册用户名"/>
                    </li>
                    
                    <li>
                        <i class="iconfont icon-icon--"></i>
                        <input type="text" class="txt txt-code"  name="reginfo[mobile]" id="newmobile" value="" placeholder="11位手机号码"/>
                    </li>
                    
                    <li>
                        <i class="iconfont icon-youjian"></i>
                        <input class="res-user" type="text" id="newemail" name="reginfo[email]" value="" placeholder="电子邮箱"/>
                    </li>
  
                     {if sysconf('site_register_smscode_status')==1}
                          <li class="ver-btn">
                             <i class="iconfont icon-icon--"></i>
                           <input class="res-user" type="text" name="reginfo[chkcode]" id="code" value="" placeholder="手机验证码"/>
                            {if sysconf('site_register_code_type') == 'sms'}
                                <a class="btn-code" href="javascript:;" id="click_checkcode_phone">发送验证码</a>
                                </li>
                            {elseif sysconf('site_register_code_type') == 'email'}
                            
                            <a class="btn-code" href="javascript:;" id="click_checkcode_email">发送验证码</a>
                            </li>
                            {/if}
                            {/if}
                           
                        
                        {if sysconf('spread_invite_code')==1}
                            <div class="user_input">
                                <i class="iconfont icon-mima"></i><input type="text" name="reginfo[invite_code]" placeholder="邀请码{if sysconf('is_need_invite_code')==1}（必填）{else}（选填）{/if}"
                                    class="lxfs">
                            </div>
                         {/if}
                        <li>
                        <i class="iconfont icon-mima"></i>
                        <input class="res-password" type="password" id="password1" name='reginfo[password]' value="" placeholder="密码"/>
                    </li>
                    <li>
                        <i class="iconfont icon-queren"></i>
                        <input class="res-password" type="password" id="password2" name='reginfo[confirmpassword]' placeholder="确认密码"/>
                    </li>
                    <li>
                        <i class="iconfont icon-qq"></i>
                        <input class="res-password" type="text" id="newqq" name='reginfo[qq]' placeholder="QQ号码"/>
                    </li>
                
                {if sysconf('spread_invite_code')==1}
					 <li class="ver-btn">
                        <i class="iconfont icon-icon--"></i>
                        <input type="text" class="txt txt-code"  name="reginfo[invite_code]" id="newmobile" value="" placeholder="邀请码{if sysconf('is_need_invite_code')==1}（必填）{else}（选填）{/if}"/>
                        <a class="btn-code" href="{:sysconf('yqmgmsplj')}" target="_blank" >购买邀请码</a>
                    </li>
                    {/if}
                                    </ul>
                <div class="rule">
                    <label>
                        <input name="" type="checkbox" id="rule" value="" checked />
                        <label for="rule"><i class="iconfont icon-queren"></i></label>
                        我已阅读并接受<a id="agreement" href="javascript:;" target="_blank" style="color: #00b8b3;">《服务协议》</a>
                    </label>
                </div>
            </div>
            <div class="foot">
                <input type="button" class="btn" name="" id="regBtn" value="注 册" />
                <p>有账号，<a href="/login">去登录</a></p>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript" src="/static/app/cyfaka/js/jquery.js"></script>
<script type="text/javascript" src="/static/app/cyfaka/js/getVerifyCode.js"></script>
<script type="text/javascript" src="/static/app/cyfaka/js/script.js"></script>
<script src="/static/app/js/formvalidator_min.js"></script>
<script src="/static/app/js/formvalidatorregex.js"></script>
<script src="/static/app/js/layer.js"></script>

     <script type="text/javascript">
            $('#agreement').click(function () {
                layer.open({
                    type: 2,
                    title: '服务协议',
                    area: ['40%','45%'],
                    anim: 2,
                    content: ['/index/index/agreement']

                });
            })
            $(function () {
                $('#click_checkcode_phone').on('click', getCode);
                $('#click_checkcode_email').on('click', getEmailCode);
            });
            var token = "{$sms_token}";

    function getCode() {
        var phone = $('#newmobile').val();
        //var name=$('#newusername').val();
        var reg = /\d{11}/;
        if (phone == '' || !reg.test(phone)) {
            layer.msg('请填写正确的手机号码！');
            $('#newmobile').focus();
            return false;
        }
		
		layer.prompt({
		title: '请输入验证码',
		formType: 3
		}, function (chkcode) {
		$('#click_checkcode_phone').off('click');
		$.post('/register/sms', {
		chkcode: chkcode,
		token: token,
		phone: phone,
		t: new Date().getTime()
		}, function (ret) {
		if (ret.code === 1) {
		layer.closeAll();
		layer.msg(ret.msg);
		token = ret.data.token;
		$('#click_checkcode_phone').html('<i class="times">80</i> 秒后重发');
		timeC(80, '#click_checkcode_phone');
		} else {
		alert(ret.msg);
		$('#click_checkcode_phone').on('click', getCode);
		}
		}, 'json');
		layer.closeAll();  //新增
		})
		$('.layui-layer-prompt .layui-layer-content').prepend($(
		'<img style="cursor:pointer;height: 60px;" id="chkcode_img" src="/chkcode" onclick="javascript:this.src=\'/chkcode\'+\'?time=\'+Math.random()">'
		))	
    }
    //邮箱验证
            function getEmailCode() {
                var email = $('#newemail').val();
                var reg =
                    /^([\w-.]+)@(([[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.)|(([\w-]+.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(]?)$/;
                if (email == '' || !reg.test(email)) {
                    alert('请填写正确的邮箱！');
                    $('#newemail').focus();
                    return false;
                }
                $('#click_checkcode_email').off('click');
                $.post('/register/email', {
                    email: email,
                    t: new Date().getTime()
                }, function (ret) {
                    //                        console.log(ret);
                    if (ret.code === 1) {
                        layer.closeAll();
                        layer.msg(ret.msg);
                        $('#click_checkcode_email').html('<i class="times">80</i> 秒后重发');
                        timeC(80, "#click_checkcode_email");
                    } else {
                        alert(ret.msg);
                        $('#click_checkcode_email').on('click', getEmailCode);
                    }
                }, 'json');
            }
    function timeC(t) {
        if (t == 0) {
            $('.btn-code').on('click', getCode);
            $('.btn-code').text('获取验证码');
        } else {
            t = t - 1;
            $('.btn-code span.times').text(t);
            setTimeout('timeC(' + t + ')', 1000);
        }
    }

    $(function () {
        $("#newusername").focus();

        $("#r2").click(function () {
            $(".btn-code").attr("disabled", true);
            $(".btn-code").addClass('notallowsubmit');
        });

        $("#r1").click(function () {
            $(".btn-code").attr("disabled", false);
            $(".btn-code").removeClass('notallowsubmit');
        });
        $.formValidator.initConfig({
            formid: "reg", onerror: function (msg) {
                layer.msg(msg)
                return false;
            }, onsuccess: function () {
                return true;
            }
        });
        $("#newusername").formValidator({
            onshow: " ",
            onfocus: "请输入正确的用户名",
            onempty: "用户名是您登录账户的凭证，一定要填写哦",
            oncorrect: "<font color=green>√该用户名可以注册</font>"
        }).ajaxValidator({
                type: "get",
                url: "/register/checkuser",
                success: function (data) {
                    if (data == 0) {
                        return true;
                    } else {
                        return false;
                    }
                },
                buttons: $(".btn_zc"),
                error: function () {
                    layer.msg("服务器没有返回数据，可能服务器忙，请重试！");
                },
                onerror: "<font color=red> * 该用户名已被使用，请更换！</font>",
                onwait: "正在对用户名进行合法性校验，请稍候..."
        });

        $("#newemail").formValidator({
            onshow: " ",
            onfocus: "用于找回密码、接收校验信息等操作",
            oncorrect: "<font color=green> √ 邮箱地址填写完成</font>",
            defaultvalue: ""
        }).inputValidator({
            min: 6,
            max: 100,
            onerror: "你填写的邮箱地址长度不正确,请确认"
        }).regexValidator({
            regexp: "^([\\w-.]+)@(([[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.)|(([\\w-]+.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(]?)$",
            onerror: "你填写的邮箱格式不正确"
        });
        $("#newidcard").formValidator({
            empty: true,
            onshow: "身份证",
            onfocus: "身份证",
            oncorrect: "请确认无误，注册后不能修改。",
            onempty: "注册后不能修改"
        }).inputValidator({max: 18, onerror: "最多18位字符"});
        $("#newqq").formValidator({
            onshow: " ",
            onfocus: "请填写联系QQ号码",
            oncorrect: "<font color=green> √ QQ填写完成</font>",
            onempty: "QQ一定填写哦"
        }).inputValidator({min: 5, max: 12, onerror: "QQ号最少5位，最多11位数字"}).regexValidator({
            regexp: "qq",
            datatype: "enum",
            onerror: "您输入的QQ帐号不正确"
        });
        $("#password1").formValidator({
            onshow: " ",
            onfocus: "密码不能为空",
            oncorrect: "<font color=green> √ 密码填写完成</font>"
        }).inputValidator({
            min: 8,
            empty: {leftempty: false, rightempty: false, emptyerror: "密码两边不能有空符号"},
            onerror: "密码长度为8-16位,请确认"
        });
        $("#password2").formValidator({
            onshow: " ",
            onfocus: "两次密码必须一致哦",
            oncorrect: "<font color=green> √ 密码一致</font>"
        }).inputValidator({
            min: 8,
            empty: {leftempty: false, rightempty: false, emptyerror: "重复密码两边不能有空符号"},
            onerror: "密码长度为8-16位,请确认"
        }).compareValidator({desid: "password1", operateor: "=", onerror: "2次密码不一致,请确认"});
        $('#regBtn').click(function () {
            $usernameLength = getStrLeng($('#newusername').val());
            if($usernameLength<4) {
                layer.msg('用户名长度错误，长度不得小于4个字符');
                return false;
            }
            if($usernameLength>20) {
                layer.msg('用户名长度错误，长度不得大于20个字符');
                return false;
            }
            if ($(".onError").length > 0) {
                layer.msg($(".onError").first().text());
                return false;
            }
            if(false === $("#rule").is(':checked')) {
                layer.msg('请先同意服务协议');
                return false;
            }
            var loading = '';
            $.ajax({
                type: 'post',
                url: '/index/user/doRegister',
                dataType: "json",
                data: $("form").serialize(),
                beforeSend: function (xhr) {
                    loading = layer.load()
                },
                success: function (res) {
                    layer.close(loading);
                    if (res.code == 1) {
                        layer.alert(res.msg, function () {
                            window.location.href = '/login.html';
                        });
                    } else {
                        layer.msg(res.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    layer.close(loading);
                    layer.msg('连接错误');
                }
            });
        })
    });
    function getStrLeng(str){
        var realLength = 0;
        var len = str.length;
        var charCode = -1;
        for(var i = 0; i < len; i++){
            charCode = str.charCodeAt(i);
            if (charCode >= 0 && charCode <= 128) {
                realLength += 1;
            }else{
                // 如果是中文则长度加3
                realLength += 3;
            }
        }
        return realLength;
    }
</script>


</body>
</html>

